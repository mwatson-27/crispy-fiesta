<script>
let imageFiles = [];
let ratings = {};
const K = 32;

async function loadImages() {
    const res = await fetch("images.json");
    imageFiles = await res.json();

    ratings = JSON.parse(localStorage.getItem("eloRatings")) || {};

    imageFiles.forEach(file => {
        if (!ratings[file]) ratings[file] = 1200;
    });

    saveRatings();
    loadBattle();
}

function saveRatings() {
    localStorage.setItem("eloRatings", JSON.stringify(ratings));
}

function getRandomMatchup() {
    const shuffled = [...imageFiles].sort(() => 0.5 - Math.random());
    return [shuffled[0], shuffled[1]];
}

function updateElo(winner, loser) {
    const rw = ratings[winner];
    const rl = ratings[loser];

    const expected = 1 / (1 + Math.pow(10, (rl - rw) / 400));

    ratings[winner] = rw + K * (1 - expected);
    ratings[loser] = rl + K * (0 - (1 - expected));

    saveRatings();
}

function loadBattle() {
    if (imageFiles.length < 2) {
        document.getElementById("battle").innerHTML = "Not enough images.";
        return;
    }

    const [img1, img2] = getRandomMatchup();

    document.getElementById("battle").innerHTML = `
        <div>
            <img src="static/uploads/${img1}" width="300" onclick="vote('${img1}','${img2}')">
            <div>${img1.replace(/\.[^/.]+$/, "")}</div>
        </div>
        <div>
            <img src="static/uploads/${img2}" width="300" onclick="vote('${img2}','${img1}')">
            <div>${img2.replace(/\.[^/.]+$/, "")}</div>
        </div>
    `;
}

function vote(winner, loser) {
    updateElo(winner, loser);
    loadBattle();
}

loadImages();
</script>
